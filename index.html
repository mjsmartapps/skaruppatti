<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karuppatti Village Store</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Jost:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2C1810', // Deep Earthy Brown (Karuppatti)
                        secondary: '#D4AF37', // Metallic Gold / Jaggery
                        accent: '#F5E6D3', // Warm Cream / Palm Sap
                        surface: '#FFFCF0', // Rice Paper White
                        leaf: '#4A5D23', // Muted Village Green
                    },
                    fontFamily: {
                        decorative: ['"Cinzel Decorative"', 'cursive'],
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Jost"', 'sans-serif'],
                    },
                    backgroundImage: {
                        'texture': "url('https://www.transparenttextures.com/patterns/cream-paper.png')"
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'sway': 'sway 4s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        sway: {
                            '0%, 100%': { transform: 'rotate(-3deg)' },
                            '50%': { transform: 'rotate(3deg)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- GLOBAL STYLES --- */
        body {
            font-family: 'Jost', sans-serif;
            background-color: #FFFCF0;
            background-image: url('https://www.transparenttextures.com/patterns/natural-paper.png'); /* Subtle Paper Texture */
            color: #2C1810;
            overflow-x: hidden;
        }
        
        .brand-font { font-family: 'Playfair Display', serif; }
        .decor-font { font-family: 'Cinzel Decorative', cursive; }

        /* --- CUSTOM SCROLLBAR --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #F5E6D3; }
        ::-webkit-scrollbar-thumb { background: #D4AF37; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #2C1810; }

        /* --- VILLAGE LOADER ANIMATION --- */
        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #FFFCF0, #F5E6D3);
            z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s ease-out;
        }

        .village-scene { position: relative; width: 120px; height: 120px; margin-bottom: 20px; }
        
        .sun {
            width: 60px; height: 60px; background: #D4AF37; border-radius: 50%;
            position: absolute; bottom: 10px; left: 30px;
            box-shadow: 0 0 40px #D4AF37;
            animation: sunrise 2s ease-out forwards;
        }

        .palm-icon {
            font-size: 80px; color: #2C1810; position: absolute; bottom: 0; left: 20px;
            transform-origin: bottom center;
            animation: treeSway 3s ease-in-out infinite;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.2);
        }

        @keyframes sunrise {
            0% { transform: translateY(50px) scale(0.5); opacity: 0; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        @keyframes treeSway {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        /* --- ATMOSPHERIC BACKGROUND --- */
        #village-atmosphere {
            position: fixed; inset: 0; pointer-events: none; z-index: -1; overflow: hidden;
        }
        
        /* Floating Dust Particles */
        .pollen {
            position: absolute; background: #D4AF37; border-radius: 50%; opacity: 0.6;
            filter: blur(1px); animation: floatUp 15s linear infinite;
        }
        @keyframes floatUp {
            from { transform: translateY(100vh) translateX(0); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            to { transform: translateY(-100px) translateX(50px); opacity: 0; }
        }

        /* Parallax Leaf Overlay */
        .leaf-overlay {
            position: fixed; top: -50px; right: -50px; width: 300px; opacity: 0.05;
            animation: gentleSway 10s ease-in-out infinite; pointer-events: none;
        }
        @keyframes gentleSway { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(5deg); } }

        /* --- GLASSMORPHISM COMPONENTS --- */
        .glass-panel {
            background: rgba(255, 252, 240, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 8px 32px rgba(44, 24, 16, 0.05);
        }
        
        .gold-border-bottom {
            position: relative;
        }
        .gold-border-bottom::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, #D4AF37, transparent);
        }

        /* --- UTILS --- */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        .card-hover-effect {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .card-hover-effect:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(44, 24, 16, 0.15);
            border-color: #D4AF37;
        }

        /* Toast */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 6000; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: #2C1810; color: #F5E6D3; padding: 16px 24px; border-radius: 8px;
            border-left: 4px solid #D4AF37; display: flex; align-items: center; gap: 12px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    </style>
</head>
<body class="flex flex-col min-h-screen selection:bg-secondary selection:text-primary">

    <div id="village-atmosphere">
        <img src="https://cdn-icons-png.flaticon.com/512/892/892926.png" class="leaf-overlay invert sepia saturate-0 opacity-10" alt="">
        </div>

    <div id="loader-overlay">
        <div class="village-scene">
            <div class="sun"></div>
            <i class="fa-solid fa-tree palm-icon"></i>
        </div>
        <h1 class="decor-font text-3xl text-primary tracking-widest font-bold mt-4 animate-pulse">KARUPPATTI</h1>
        <p class="font-serif text-secondary text-sm tracking-[0.3em] uppercase mt-2">Village Heritage Store</p>
    </div>

    <div id="toast-container"></div>

    <header class="fixed top-4 left-4 right-4 z-40">
        <div class="glass-panel rounded-full px-6 py-3 flex items-center justify-between container mx-auto max-w-6xl shadow-lg">
            
            <div class="flex items-center gap-6">
                <button onclick="toggleDrawer(true)" class="text-primary hover:text-secondary transition transform hover:scale-110">
                    <i class="fa-solid fa-bars-staggered text-xl"></i>
                </button>
                
                <div class="hidden md:flex items-center gap-2">
                     <i class="fa-solid fa-location-dot text-secondary"></i>
                     <span class="text-xs font-bold text-primary tracking-wide">Tamil Nadu, IN</span>
                </div>
            </div>

            <div class="text-center absolute left-1/2 transform -translate-x-1/2">
                <h1 class="decor-font text-xl md:text-2xl font-bold text-primary tracking-wide">KARUPPATTI <span class="text-secondary">VILLAGE</span></h1>
            </div>

            <div class="flex items-center gap-5">
                <div class="relative cursor-pointer group" onclick="openCartModal()">
                    <div class="p-2 rounded-full hover:bg-accent transition duration-300">
                        <i class="fa-solid fa-basket-shopping text-xl text-primary group-hover:text-secondary transition"></i>
                    </div>
                    <span id="cart-badge" class="absolute top-0 right-0 bg-secondary text-white text-[10px] font-bold rounded-full h-5 w-5 flex items-center justify-center border-2 border-white shadow-sm hidden transform scale-0 transition-transform duration-300">0</span>
                </div>

                <div class="relative">
                    <button id="login-btn-header" onclick="toggleModal('login-modal', true)" class="bg-primary text-secondary px-6 py-2 rounded-full text-xs font-bold hover:bg-secondary hover:text-primary transition shadow-md tracking-wider border border-secondary/20">
                        LOGIN
                    </button>
                    
                    <div id="user-profile-header" class="hidden flex items-center gap-3 cursor-pointer" onclick="toggleUserMenu()">
                        <div class="w-10 h-10 rounded-full bg-secondary p-0.5 shadow-md">
                            <img id="user-avatar" src="" onerror="this.style.display='none'" class="w-full h-full rounded-full object-cover border-2 border-white hidden">
                            <div id="user-icon-default" class="w-full h-full rounded-full bg-primary flex items-center justify-center text-secondary border-2 border-white">
                                <i class="fa-solid fa-user"></i>
                            </div>
                        </div>
                    </div>

                    <div id="user-menu-dropdown" class="absolute top-14 right-0 glass-panel rounded-xl w-56 py-2 hidden origin-top-right transition-all duration-200 transform scale-95 opacity-0">
                        <div class="px-4 py-3 border-b border-primary/10">
                            <p class="text-xs text-gray-500 uppercase">Signed in as</p>
                            <p class="text-sm font-bold text-primary truncate" id="menu-user-name">User</p>
                        </div>
                        <a href="#" onclick="openProfileModal(); toggleUserMenu()" class="px-5 py-3 hover:bg-accent/50 flex items-center text-sm text-primary transition"><i class="fa-solid fa-id-card-clip w-6 text-secondary"></i> My Profile</a>
                        <a href="#" onclick="openOrdersModal(); toggleUserMenu()" class="px-5 py-3 hover:bg-accent/50 flex items-center text-sm text-primary transition"><i class="fa-solid fa-box-archive w-6 text-secondary"></i> Orders</a>
                        <div class="h-px bg-primary/10 my-1"></div>
                        <a href="#" onclick="logoutUser(); toggleUserMenu()" class="px-5 py-3 text-red-700 hover:bg-red-50 flex items-center text-sm transition"><i class="fa-solid fa-arrow-right-from-bracket w-6"></i> Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div id="drawer-overlay" onclick="toggleDrawer(false)" class="fixed inset-0 bg-primary/40 backdrop-blur-sm z-50 hidden transition-opacity opacity-0"></div>
    <aside id="drawer" class="fixed top-0 left-0 h-full w-80 glass-panel z-[60] transform -translate-x-full shadow-2xl flex flex-col">
        <div class="p-8 border-b border-secondary/20 flex justify-between items-center bg-accent/30">
            <div>
                <h2 class="decor-font text-2xl text-primary font-bold">Menu</h2>
                <p class="text-xs font-serif italic text-gray-500">Traditional & Pure</p>
            </div>
            <button onclick="toggleDrawer(false)" class="w-8 h-8 rounded-full bg-white text-primary hover:bg-red-50 hover:text-red-500 transition flex items-center justify-center shadow-sm">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <nav class="p-6 space-y-2 flex-1 overflow-y-auto">
            <a href="#home" onclick="toggleDrawer(false)" class="flex items-center gap-4 px-4 py-4 text-primary hover:bg-white hover:shadow-sm rounded-xl transition group">
                <span class="w-8 h-8 rounded-full bg-accent flex items-center justify-center text-secondary group-hover:bg-primary group-hover:text-white transition"><i class="fa-solid fa-house-chimney"></i></span>
                <span class="font-medium font-serif">Home</span>
            </a>
            <a href="#products" onclick="toggleDrawer(false)" class="flex items-center gap-4 px-4 py-4 text-primary hover:bg-white hover:shadow-sm rounded-xl transition group">
                <span class="w-8 h-8 rounded-full bg-accent flex items-center justify-center text-secondary group-hover:bg-primary group-hover:text-white transition"><i class="fa-solid fa-wheat-awn"></i></span>
                <span class="font-medium font-serif">Our Collections</span>
            </a>
            <a href="#" onclick="openCartModal(); toggleDrawer(false);" class="flex items-center gap-4 px-4 py-4 text-primary hover:bg-white hover:shadow-sm rounded-xl transition group">
                <span class="w-8 h-8 rounded-full bg-accent flex items-center justify-center text-secondary group-hover:bg-primary group-hover:text-white transition"><i class="fa-solid fa-basket-shopping"></i></span>
                <span class="font-medium font-serif">My Basket</span>
            </a>
        </nav>

        <div class="p-6 bg-primary text-accent relative overflow-hidden">
            <i class="fa-solid fa-leaf absolute -bottom-4 -right-4 text-6xl text-white/5"></i>
            <p class="font-serif italic text-center text-sm opacity-80">"Nature's Sweetness, <br>Village Goodness"</p>
        </div>
    </aside>

    <main class="flex-grow w-full pt-28 pb-12 px-4 md:px-8 max-w-7xl mx-auto">
        
        <section id="home" class="relative rounded-[2rem] overflow-hidden shadow-2xl h-[500px] mb-16 group">
            <div class="absolute inset-0 bg-gray-900">
                <img src="https://images.unsplash.com/photo-1629196914375-f7e48f477b6d?q=80&w=2070&auto=format&fit=crop" 
                     alt="Village Farm" 
                     class="w-full h-full object-cover opacity-70 transition-transform duration-[10s] ease-linear transform group-hover:scale-110">
            </div>
            
            <div class="absolute inset-0 bg-gradient-to-t from-primary/90 via-primary/30 to-transparent flex flex-col justify-end p-8 md:p-16 text-center md:text-left">
                <div class="max-w-2xl animate-float">
                    <span class="inline-block px-4 py-1 rounded-full bg-secondary/20 backdrop-blur-md border border-secondary/50 text-secondary text-xs font-bold tracking-[0.2em] mb-4 uppercase">Direct from Farmers</span>
                    <h2 class="text-4xl md:text-6xl font-bold text-surface mb-4 brand-font leading-tight drop-shadow-lg">
                        Pure <span class="text-secondary italic">Palm Jaggery</span> <br>& Naturals
                    </h2>
                    <p class="text-accent/90 text-lg md:text-xl font-light tracking-wide mb-8 max-w-lg leading-relaxed">
                        Experience the authentic taste of tradition. Handcrafted Karuppatti, organic millets, and farm-fresh spices sourced from the heart of the village.
                    </p>
                    <button onclick="document.getElementById('products').scrollIntoView({behavior: 'smooth'})" class="group relative px-8 py-4 bg-secondary text-primary font-bold rounded-full overflow-hidden shadow-[0_0_20px_rgba(212,175,55,0.4)] transition-all hover:scale-105">
                        <span class="relative z-10 flex items-center gap-3">EXPLORE PRODUCTS <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition"></i></span>
                        <div class="absolute inset-0 bg-white/30 transform -translate-x-full skew-x-12 group-hover:animate-shine"></div>
                    </button>
                </div>
            </div>
        </section>

        <div id="products" class="relative">
            <div class="flex flex-col md:flex-row justify-between items-end mb-10 pb-4 gold-border-bottom gap-4">
                <div>
                    <span class="text-xs font-bold text-secondary uppercase tracking-[0.3em] block mb-2">Fresh Harvest</span>
                    <h3 class="text-3xl md:text-4xl font-bold text-primary brand-font">Our Collections</h3>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="window.location.reload()" class="px-4 py-2 bg-white border border-secondary/30 rounded-full text-xs font-bold text-primary hover:bg-secondary hover:text-white transition shadow-sm flex items-center gap-2">
                        <i class="fa-solid fa-rotate"></i> REFRESH
                    </button>
                </div>
            </div>
            
            <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8 min-h-[300px]">
                <div class="col-span-full flex flex-col justify-center items-center h-60 opacity-60">
                    <div class="w-12 h-12 border-4 border-secondary border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p class="font-serif text-primary italic">Gathering harvest...</p>
                </div>
            </div>
        </div>

    </main>

    <footer class="bg-primary text-surface relative mt-auto border-t-8 border-secondary overflow-hidden">
        <div class="absolute inset-0 opacity-10" style="background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');"></div>
        
        <div class="container mx-auto px-8 pt-16 pb-8 relative z-10">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-12">
                <div class="md:col-span-1">
                    <h3 class="decor-font text-2xl text-secondary mb-6">Karuppatti</h3>
                    <p class="text-accent/60 text-sm leading-7 font-light">
                        Born from the red soil. We bridge the gap between traditional farmers and your modern table, delivering unadulterated goodness wrapped in nature's love.
                    </p>
                </div>

                <div>
                    <h4 class="font-serif text-lg mb-6 text-white border-b border-secondary/30 inline-block pb-1">Discover</h4>
                    <ul class="space-y-3 text-sm text-accent/80">
                        <li><a href="#" onclick="toggleModal('about-modal', true)" class="hover:text-secondary transition flex items-center gap-2 group"><span class="w-1 h-1 bg-secondary rounded-full opacity-0 group-hover:opacity-100 transition"></span> Our Story</a></li>
                        <li><a href="#" onclick="toggleModal('terms-modal', true)" class="hover:text-secondary transition flex items-center gap-2 group"><span class="w-1 h-1 bg-secondary rounded-full opacity-0 group-hover:opacity-100 transition"></span> Terms of Harvest</a></li>
                        <li><a href="#" onclick="toggleModal('privacy-modal', true)" class="hover:text-secondary transition flex items-center gap-2 group"><span class="w-1 h-1 bg-secondary rounded-full opacity-0 group-hover:opacity-100 transition"></span> Privacy Policy</a></li>
                    </ul>
                </div>

                <div>
                    <h4 class="font-serif text-lg mb-6 text-white border-b border-secondary/30 inline-block pb-1">Visit Us</h4>
                    <ul class="space-y-4 text-sm text-accent/80">
                        <li class="flex gap-4">
                            <i class="fa-solid fa-location-dot text-secondary mt-1"></i> 
                            <span>123, Heritage Farm Road,<br>Theni District, Tamil Nadu</span>
                        </li>
                        <li class="flex gap-4">
                            <i class="fa-solid fa-phone text-secondary mt-1"></i> 
                            <span>+91 98765 43210</span>
                        </li>
                    </ul>
                </div>

                <div>
                    <h4 class="font-serif text-lg mb-6 text-white border-b border-secondary/30 inline-block pb-1">Join the Village</h4>
                    <div class="flex gap-4 mb-6">
                        <a href="#" class="w-10 h-10 rounded-full border border-secondary/30 flex items-center justify-center text-secondary hover:bg-secondary hover:text-primary transition"><i class="fa-brands fa-instagram"></i></a>
                        <a href="#" class="w-10 h-10 rounded-full border border-secondary/30 flex items-center justify-center text-secondary hover:bg-secondary hover:text-primary transition"><i class="fa-brands fa-facebook-f"></i></a>
                        <a href="#" class="w-10 h-10 rounded-full border border-secondary/30 flex items-center justify-center text-secondary hover:bg-secondary hover:text-primary transition"><i class="fa-brands fa-whatsapp"></i></a>
                    </div>
                </div>
            </div>

            <div class="border-t border-white/10 mt-12 pt-8 text-center text-xs text-accent/40 font-serif">
                <p>Designed with <i class="fa-solid fa-heart text-red-500 mx-1"></i> by <a href="https://www.mjsmartapps.xyz" target="_blank" class="text-secondary hover:text-white transition font-bold">MJ SMART APPS</a></p>
            </div>
        </div>
    </footer>

    <div id="login-modal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-primary/60 backdrop-blur-md transition-opacity" onclick="toggleModal('login-modal', false)"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-sm p-4">
            <div class="glass-panel rounded-3xl p-8 relative overflow-hidden text-center shadow-2xl">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-secondary to-primary"></div>
                <button onclick="toggleModal('login-modal', false)" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition"><i class="fa-solid fa-xmark text-xl"></i></button>
                
                <div class="w-16 h-16 bg-accent rounded-full flex items-center justify-center mx-auto mb-6 text-2xl text-primary shadow-inner">
                    <i class="fa-solid fa-user-lock"></i>
                </div>
                
                <h2 class="text-2xl font-bold text-primary brand-font mb-2">Welcome Back</h2>
                <p class="text-gray-500 text-xs mb-8">Access your orders & saved items</p>

                <div id="login-process-loader" class="hidden mb-4">
                    <i class="fa-solid fa-circle-notch fa-spin text-secondary text-2xl"></i>
                </div>

                <button onclick="handleGoogleSignIn()" class="w-full bg-white border border-gray-200 py-3 rounded-xl font-bold text-gray-700 hover:bg-gray-50 hover:border-secondary transition flex items-center justify-center gap-3 shadow-sm group">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5 group-hover:scale-110 transition"> 
                    <span>Sign in with Google</span>
                </button>
            </div>
        </div>
    </div>

    <div id="cart-modal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-primary/60 backdrop-blur-md transition-opacity" onclick="toggleModal('cart-modal', false)"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-4xl p-4">
            <div class="glass-panel rounded-3xl overflow-hidden shadow-2xl flex flex-col md:flex-row max-h-[90vh]">
                
                <div class="w-full md:w-3/5 p-6 md:p-8 bg-white/50 overflow-y-auto hide-scrollbar">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-primary brand-font flex items-center gap-2">
                            <i class="fa-solid fa-basket-shopping text-secondary"></i> Your Basket
                        </h2>
                        <span class="text-xs font-bold bg-accent text-primary px-3 py-1 rounded-full" id="cart-count-header">0 Items</span>
                    </div>

                    <div id="cart-items-container" class="space-y-4 min-h-[200px]">
                        </div>

                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <div class="flex justify-between items-end">
                            <span class="text-sm font-bold text-gray-500 uppercase tracking-widest">Total Amount</span>
                            <span id="cart-total-price" class="text-3xl font-bold text-primary brand-font">₹0</span>
                        </div>
                    </div>
                </div>

                <div class="w-full md:w-2/5 p-6 md:p-8 bg-surface border-l border-secondary/20 relative overflow-y-auto hide-scrollbar">
                    <button onclick="toggleModal('cart-modal', false)" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
                    
                    <h3 class="text-lg font-bold text-primary mb-6 brand-font">Delivery Details</h3>
                    
                    <form onsubmit="handlePlaceOrder(event)" class="space-y-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-primary/60 uppercase tracking-wider">Recipient Name</label>
                            <input type="text" id="checkout-name" required class="w-full px-4 py-3 rounded-lg bg-white border border-gray-200 focus:border-secondary focus:ring-1 focus:ring-secondary outline-none text-sm transition shadow-sm">
                        </div>

                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-primary/60 uppercase tracking-wider">Phone Number</label>
                            <input type="tel" id="checkout-phone" required pattern="\d{10}" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 10)" class="w-full px-4 py-3 rounded-lg bg-white border border-gray-200 focus:border-secondary focus:ring-1 focus:ring-secondary outline-none text-sm transition shadow-sm">
                        </div>

                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-primary/60 uppercase tracking-wider">Email</label>
                            <input type="email" id="checkout-email" required class="w-full px-4 py-3 rounded-lg bg-white border border-gray-200 focus:border-secondary focus:ring-1 focus:ring-secondary outline-none text-sm transition shadow-sm">
                        </div>

                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-primary/60 uppercase tracking-wider">Full Address</label>
                            <textarea id="checkout-address" required rows="2" class="w-full px-4 py-3 rounded-lg bg-white border border-gray-200 focus:border-secondary focus:ring-1 focus:ring-secondary outline-none text-sm transition shadow-sm"></textarea>
                        </div>
                        
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-primary/60 uppercase tracking-wider">GPS Location</label>
                            <div class="flex gap-2">
                                <input type="text" id="checkout-location" readonly class="flex-1 px-4 py-2 rounded-lg bg-gray-50 border border-gray-200 text-xs focus:outline-none text-gray-500" placeholder="Coordinates">
                                <button type="button" onclick="getCheckoutLocation()" class="bg-primary text-secondary text-xs font-bold px-3 rounded-lg hover:bg-secondary hover:text-primary transition shadow-sm whitespace-nowrap">
                                    <i class="fa-solid fa-location-crosshairs"></i> Detect
                                </button>
                            </div>
                        </div>

                        <div id="order-loader" class="hidden flex justify-center py-2">
                            <i class="fa-solid fa-circle-notch fa-spin text-secondary text-xl"></i>
                        </div>

                        <button type="submit" id="place-order-btn" class="w-full bg-secondary text-primary py-4 rounded-xl font-bold hover:bg-primary hover:text-white transition shadow-lg mt-4 uppercase tracking-[0.2em] text-xs">
                            Confirm Order
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="info-modal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-primary/60 backdrop-blur-md" onclick="toggleModal('info-modal', false)"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-lg p-4">
            <div class="glass-panel rounded-3xl p-8 relative max-h-[80vh] overflow-y-auto shadow-2xl">
                <button onclick="toggleModal('info-modal', false)" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
                <h2 id="info-modal-title" class="text-3xl font-bold text-primary mb-6 brand-font border-b border-secondary/30 pb-2">Title</h2>
                <div id="info-modal-content" class="text-sm text-gray-700 space-y-4 leading-relaxed font-sans">
                    </div>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-primary/60 backdrop-blur-md" onclick="toggleModal('profile-modal', false)"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-4">
            <div class="glass-panel rounded-3xl p-8 relative max-h-[90vh] overflow-y-auto hide-scrollbar shadow-2xl">
                <button onclick="toggleModal('profile-modal', false)" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
                <div id="profile-content-area"></div>
            </div>
        </div>
    </div>

    <div id="orders-modal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-primary/60 backdrop-blur-md" onclick="toggleModal('orders-modal', false)"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl p-4">
            <div class="glass-panel rounded-3xl p-8 relative max-h-[85vh] overflow-y-auto hide-scrollbar shadow-2xl">
                <button onclick="toggleModal('orders-modal', false)" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
                <h2 class="text-2xl font-bold text-primary mb-6 brand-font border-b border-secondary/30 pb-2">Purchase History</h2>
                <div id="orders-list-container" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref, onValue, set, get, push, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCu_WUd66NRLa_8uI06UXVTlkDh74dMBqU",
            authDomain: "vasanth-ee54c.firebaseapp.com",
            databaseURL: "https://vasanth-ee54c-default-rtdb.firebaseio.com",
            projectId: "vasanth-ee54c",
            storageBucket: "vasanth-ee54c.firebasestorage.app",
            messagingSenderId: "668556425496",
            appId: "1:668556425496:web:1b3aab6bf95a5baa19c66d",
            measurementId: "G-8R23976J89",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const rtdb = getDatabase(app);

        window.cart = {}; 
        window.productsMap = {};
        window.currentUserData = null; 

        // --- ANIMATION INIT ---
        const villageAtmosphere = document.getElementById('village-atmosphere');
        for(let i=0; i<20; i++) {
            const particle = document.createElement('div');
            particle.className = 'pollen';
            const size = Math.random() * 4 + 1;
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            particle.style.left = `${Math.random() * 100}vw`;
            particle.style.animationDuration = `${Math.random() * 10 + 10}s`;
            particle.style.animationDelay = `${Math.random() * 10}s`;
            villageAtmosphere.appendChild(particle);
        }

        // --- CORE UI FUNCS ---
        window.showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            const icon = type === 'success' ? '<i class="fa-solid fa-leaf text-secondary text-xl"></i>' : '<i class="fa-solid fa-circle-exclamation text-red-400 text-xl"></i>';
            toast.innerHTML = `${icon} <span class="font-medium text-sm tracking-wide">${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateX(100%)'; setTimeout(() => toast.remove(), 400); }, 3000);
        };

        window.toggleDrawer = (isOpen) => {
            const drawer = document.getElementById('drawer');
            const overlay = document.getElementById('drawer-overlay');
            if (isOpen) {
                drawer.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            } else {
                drawer.classList.add('-translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        };

        window.toggleModal = (modalId, isOpen) => {
            const modal = document.getElementById(modalId);
            if(isOpen) {
                modal.classList.remove('hidden');
                setTimeout(() => { 
                    modal.querySelector('.bg-primary\\/60').classList.remove('opacity-0');
                    if(modal.id === 'user-menu-dropdown') modal.classList.remove('opacity-0', 'scale-95');
                }, 10);
            } else {
                modal.classList.add('hidden');
            }
        };

        // Reuse Info Modal for About/Terms/Privacy to reduce code
        const openInfoModal = (title, contentHTML) => {
            document.getElementById('info-modal-title').innerText = title;
            document.getElementById('info-modal-content').innerHTML = contentHTML;
            window.toggleModal('info-modal', true);
        };
        
        // Listeners for Info Links (mapped to existing onclicks in footer)
        document.querySelectorAll('footer a[onclick^="toggleModal"]').forEach(link => {
            const originalClick = link.getAttribute('onclick');
            if(originalClick.includes('about')) {
                link.onclick = (e) => { e.preventDefault(); openInfoModal('Our Roots', '<p>Welcome to <strong>Karuppatti Village</strong>. Born from the red soil, we bring you the purest Palm Jaggery and unadulterated village harvest. Every product is a tribute to our farmers.</p>'); };
            } else if(originalClick.includes('terms')) {
                link.onclick = (e) => { e.preventDefault(); openInfoModal('Terms of Harvest', '<p><strong>Nature\'s Promise:</strong> Our products are natural. Color and texture may vary slightly, just as nature intended.<br><br><strong>Availability:</strong> Dependent on harvest seasons.</p>'); };
            } else if(originalClick.includes('privacy')) {
                link.onclick = (e) => { e.preventDefault(); openInfoModal('Privacy Policy', '<p>Your trust is sacred. We use your data only to deliver your goods and communicate order status.</p>'); };
            }
        });

        window.toggleUserMenu = () => {
            const menu = document.getElementById('user-menu-dropdown');
            if(menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                setTimeout(() => menu.classList.remove('opacity-0', 'scale-95'), 10);
            } else {
                menu.classList.add('opacity-0', 'scale-95');
                setTimeout(() => menu.classList.add('hidden'), 200);
            }
        }

        // --- PRODUCTS LOGIC ---
        const renderProductCard = (product) => {
            const cartItem = window.cart[product.id];
            const qty = cartItem ? cartItem.qty : 0;
            const unitDisplay = product.unit ? `<span class="text-[10px] text-gray-500 font-normal">/ ${product.unit}</span>` : '';
            const imgSrc = product.image || 'https://placehold.co/400x400?text=Pure';

            let btnHtml = qty === 0 
                ? `<button onclick="addToCart('${product.id}')" class="w-full py-2 bg-primary text-secondary border border-secondary text-xs font-bold rounded-lg hover:bg-secondary hover:text-primary transition uppercase tracking-wider">Add to Basket</button>`
                : `<div class="flex items-center justify-between bg-accent rounded-lg border border-secondary/30 px-2 py-1"><button onclick="changeQty('${product.id}', -1)" class="w-6 h-6 rounded flex items-center justify-center bg-white text-primary hover:bg-secondary hover:text-white transition shadow-sm font-bold">-</button><span class="font-bold text-primary text-sm">${qty}</span><button onclick="changeQty('${product.id}', 1)" class="w-6 h-6 rounded flex items-center justify-center bg-white text-primary hover:bg-secondary hover:text-white transition shadow-sm font-bold">+</button></div>`;

            return `
                <div class="glass-panel rounded-2xl overflow-hidden card-hover-effect flex flex-col group">
                    <div class="h-48 relative overflow-hidden bg-white">
                        <img src="${imgSrc}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110">
                        <div class="absolute top-2 left-2 bg-secondary text-primary text-[10px] font-bold px-2 py-1 rounded shadow-sm opacity-90 tracking-widest uppercase">Pure</div>
                    </div>
                    <div class="p-5 flex flex-col flex-grow">
                        <h4 class="font-bold text-primary text-lg line-clamp-1 font-serif mb-1">${product.name}</h4>
                        <p class="text-xs text-gray-500 mb-4 italic font-serif">${product.category || 'Natural Harvest'}</p>
                        <div class="mt-auto">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-xl font-bold text-primary font-serif">₹${product.price}${unitDisplay}</span>
                                <span class="text-[10px] text-leaf bg-green-50 px-2 py-0.5 rounded-full border border-green-100">${product.stock > 0 ? 'In Stock' : 'Sold Out'}</span>
                            </div>
                            ${product.stock > 0 ? btnHtml : '<button disabled class="w-full py-2 bg-gray-100 text-gray-400 text-xs font-bold rounded-lg cursor-not-allowed">Sold Out</button>'}
                        </div>
                    </div>
                </div>`;
        };

        const updateGrid = () => {
            const grid = document.getElementById('products-grid');
            const products = Object.values(window.productsMap);
            if(products.length > 0) grid.innerHTML = products.map(renderProductCard).join('');
            else grid.innerHTML = '<div class="col-span-full text-center py-10 opacity-60"><i class="fa-solid fa-wheat-awn text-4xl mb-2"></i><p>No harvest available.</p></div>';
        };

        const fetchProducts = () => {
            onValue(ref(rtdb, 'products'), (snapshot) => {
                const data = snapshot.val();
                window.productsMap = data ? Object.entries(data).reduce((acc, [k, v]) => ({...acc, [k]: {id: k, ...v}}), {}) : {};
                updateGrid();
            });
        };

        window.addToCart = (id) => {
            const prod = window.productsMap[id];
            if(!prod || prod.stock <= 0) { window.showToast("Out of stock", "error"); return; }
            if(!window.cart[id]) window.cart[id] = {qty: 1};
            updateCartUI();
        };

        window.changeQty = (id, change) => {
            const prod = window.productsMap[id];
            if(!window.cart[id]) return;
            const newQty = window.cart[id].qty + change;
            if(change > 0 && newQty > prod.stock) { window.showToast("Stock Limit Reached", "error"); return; }
            window.cart[id].qty = newQty;
            if(window.cart[id].qty <= 0) delete window.cart[id];
            updateCartUI();
        };

        const updateCartUI = () => {
            const totalQty = Object.values(window.cart).reduce((a, b) => a + b.qty, 0);
            const badge = document.getElementById('cart-badge');
            badge.innerText = totalQty;
            badge.classList.toggle('hidden', totalQty === 0);
            badge.classList.toggle('scale-0', totalQty === 0);
            document.getElementById('cart-count-header').innerText = `${totalQty} Items`;
            updateGrid();
            renderCartModalItems();
        };

        const renderCartModalItems = () => {
            const container = document.getElementById('cart-items-container');
            const totalEl = document.getElementById('cart-total-price');
            let total = 0;
            
            if(Object.keys(window.cart).length === 0) {
                container.innerHTML = '<div class="text-center py-10 opacity-50"><i class="fa-solid fa-basket-shopping text-4xl mb-2 text-primary"></i><p>Basket is empty.</p></div>';
                totalEl.innerText = "₹0";
                return;
            }

            container.innerHTML = Object.entries(window.cart).map(([id, item]) => {
                const prod = window.productsMap[id];
                total += prod.price * item.qty;
                return `
                    <div class="flex items-center gap-4 bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                        <img src="${prod.image || 'https://placehold.co/50'}" class="w-16 h-16 object-cover rounded-lg bg-gray-100">
                        <div class="flex-1">
                            <h5 class="font-bold text-primary font-serif">${prod.name}</h5>
                            <p class="text-xs text-gray-500">₹${prod.price} x ${item.qty}</p>
                        </div>
                        <div class="flex items-center gap-2 bg-accent/50 rounded-lg p-1">
                            <button onclick="changeQty('${id}', -1)" class="w-6 h-6 bg-white rounded shadow-sm text-xs font-bold hover:text-secondary transition">-</button>
                            <span class="text-xs font-bold w-4 text-center">${item.qty}</span>
                            <button onclick="changeQty('${id}', 1)" class="w-6 h-6 bg-white rounded shadow-sm text-xs font-bold hover:text-secondary transition">+</button>
                        </div>
                    </div>`;
            }).join('');
            totalEl.innerText = "₹" + total;
        };

        // --- AUTH & ORDERS ---
        window.handleGoogleSignIn = async () => {
            document.getElementById('login-process-loader').classList.remove('hidden');
            try { await signInWithPopup(auth, new GoogleAuthProvider()); window.showToast("Welcome to the Village!"); } 
            catch (e) { window.showToast("Login Failed", "error"); }
            document.getElementById('login-process-loader').classList.add('hidden');
        };

        window.logoutUser = () => signOut(auth).then(() => { window.cart={}; updateCartUI(); window.showToast("See you soon!"); });

        onAuthStateChanged(auth, async (user) => {
            const btn = document.getElementById('login-btn-header');
            const profile = document.getElementById('user-profile-header');
            const avatar = document.getElementById('user-avatar');
            const defIcon = document.getElementById('user-icon-default');
            
            if(user) {
                btn.classList.add('hidden'); profile.classList.remove('hidden');
                document.getElementById('menu-user-name').innerText = user.displayName || 'Guest';
                if(user.photoURL) { avatar.src = user.photoURL; avatar.classList.remove('hidden'); defIcon.classList.add('hidden'); }
                
                // Fetch User Data
                const snap = await get(ref(rtdb, 'users/' + user.uid));
                window.currentUserData = snap.val();
                
                // Auto-fill checkout
                if(window.currentUserData) {
                    document.getElementById('checkout-phone').value = window.currentUserData.phone || '';
                    document.getElementById('checkout-address').value = window.currentUserData.address || '';
                }
                document.getElementById('checkout-email').value = user.email;
                document.getElementById('checkout-name').value = user.displayName;
                window.toggleModal('login-modal', false);
            } else {
                btn.classList.remove('hidden'); profile.classList.add('hidden');
                window.currentUserData = null;
            }
        });

        // --- ORDER PROCESSING ---
        window.handlePlaceOrder = async (e) => {
            e.preventDefault();
            if(Object.keys(window.cart).length === 0) { window.showToast("Basket is empty", "error"); return; }
            
            const btn = document.getElementById('place-order-btn');
            const loader = document.getElementById('order-loader');
            btn.classList.add('hidden'); loader.classList.remove('hidden');

            try {
                // Stock Check
                const updates = {};
                for(const [id, item] of Object.entries(window.cart)) {
                    const snap = await get(ref(rtdb, `products/${id}`));
                    if(!snap.exists() || item.qty > snap.val().stock) throw new Error("Stock changed");
                    updates[`products/${id}/stock`] = snap.val().stock - item.qty;
                }

                const order = {
                    customerName: document.getElementById('checkout-name').value,
                    customerPhone: document.getElementById('checkout-phone').value,
                    email: document.getElementById('checkout-email').value,
                    address: document.getElementById('checkout-address').value + (document.getElementById('checkout-location').value ? ` [GPS: ${document.getElementById('checkout-location').value}]` : ''),
                    items: Object.entries(window.cart).map(([id, i]) => ({id, name: window.productsMap[id].name, qty: i.qty, price: window.productsMap[id].price})),
                    totalAmount: document.getElementById('cart-total-price').innerText,
                    orderDate: Date.now(),
                    status: 'Pending'
                };

                await set(push(ref(rtdb, 'orders')), order);
                await update(ref(rtdb), updates);
                
                window.cart = {}; updateCartUI(); window.toggleModal('cart-modal', false);
                window.showToast("Order Placed Successfully!");
            } catch(e) { 
                console.error(e); 
                window.showToast("Order Failed. Check Stock.", "error"); 
            } finally {
                btn.classList.remove('hidden'); loader.classList.add('hidden');
            }
        };

        window.getCheckoutLocation = () => {
             if (!navigator.geolocation) { window.showToast("Geo not supported", "error"); return; }
             navigator.geolocation.getCurrentPosition(
                 (pos) => { document.getElementById('checkout-location').value = `${pos.coords.latitude}, ${pos.coords.longitude}`; window.showToast("Location set!"); },
                 () => window.showToast("Permission denied", "error")
             );
        };

        // --- PROFILE & ORDERS MODAL LOGIC (Simplified for brevity) ---
        window.openProfileModal = () => {
            const content = document.getElementById('profile-content-area');
            if(!auth.currentUser) return;
            const data = window.currentUserData || {};
            content.innerHTML = `
                <div class="text-center mb-6">
                    <div class="w-20 h-20 mx-auto bg-accent rounded-full flex items-center justify-center text-3xl text-primary border-4 border-white shadow-lg overflow-hidden">
                        ${auth.currentUser.photoURL ? `<img src="${auth.currentUser.photoURL}" class="w-full h-full object-cover">` : '<i class="fa-solid fa-user"></i>'}
                    </div>
                    <h3 class="text-xl font-bold text-primary mt-2 brand-font">${auth.currentUser.displayName}</h3>
                    <p class="text-xs text-gray-500">${auth.currentUser.email}</p>
                </div>
                <div class="space-y-3">
                    <div class="bg-surface p-3 rounded-lg border border-secondary/20">
                        <span class="text-[10px] font-bold uppercase text-primary/60">Phone</span>
                        <p class="font-medium text-primary">${data.phone || 'Not set'}</p>
                    </div>
                    <div class="bg-surface p-3 rounded-lg border border-secondary/20">
                        <span class="text-[10px] font-bold uppercase text-primary/60">Address</span>
                        <p class="font-medium text-primary text-sm">${data.address || 'Not set'}</p>
                    </div>
                    <button onclick="window.showToast('Edit feature coming soon')" class="w-full py-2 bg-accent text-primary text-xs font-bold rounded-lg border border-secondary/30 hover:bg-secondary hover:text-white transition">EDIT PROFILE</button>
                </div>`;
            window.toggleModal('profile-modal', true);
        };

        window.openOrdersModal = async () => {
            if(!auth.currentUser) return;
            const container = document.getElementById('orders-list-container');
            container.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-circle-notch fa-spin text-secondary"></i></div>';
            window.toggleModal('orders-modal', true);
            
            const snap = await get(ref(rtdb, 'orders'));
            if(!snap.exists()) { container.innerHTML = '<p class="text-center text-gray-500 italic">No past harvests found.</p>'; return; }
            
            const orders = Object.values(snap.val()).filter(o => o.email === auth.currentUser.email).sort((a,b) => b.orderDate - a.orderDate);
            if(orders.length === 0) { container.innerHTML = '<p class="text-center text-gray-500 italic">No past harvests found.</p>'; return; }

            container.innerHTML = orders.map(o => `
                <div class="bg-surface p-4 rounded-xl border border-secondary/20">
                    <div class="flex justify-between items-center mb-2 border-b border-gray-200 pb-2">
                        <span class="text-xs font-bold text-primary">${new Date(o.orderDate).toLocaleDateString()}</span>
                        <span class="text-xs px-2 py-0.5 rounded bg-accent text-primary font-bold">${o.status}</span>
                    </div>
                    <div class="space-y-1 text-sm text-gray-600 mb-2">
                        ${o.items.map(i => `<div class="flex justify-between"><span>${i.name} x ${i.qty}</span></div>`).join('')}
                    </div>
                    <div class="text-right font-bold text-primary border-t border-gray-200 pt-1">${o.totalAmount}</div>
                </div>`).join('');
        };

        window.onload = () => {
            fetchProducts();
            setTimeout(() => document.getElementById('loader-overlay').style.opacity = '0', 2000); // Extended loader time
            setTimeout(() => document.getElementById('loader-overlay').style.display = 'none', 2800);
        };
    </script>
</body>
</html>