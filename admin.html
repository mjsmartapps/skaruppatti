<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - S Karuppatti Store</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;600&family=Mukta+Malar:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3f2305', // Deep Jaggery Brown
                        secondary: '#d97706', // Warm Amber/Copper
                        accent: '#fffbeb', // Cream/Beige
                        danger: '#ef4444',
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Inter"', 'sans-serif'],
                        tamil: ['"Mukta Malar"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fffbeb; }
        .brand-font { font-family: 'Playfair Display', serif; }
        .tamil-font { font-family: 'Mukta Malar', sans-serif; }
        
        /* Table Styles */
        .table-row-hover:hover { background-color: #fef3c7; }

        /* Toast Notification */
        #toast-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 5000;
            display: flex; flex-direction: column; gap: 10px;
        }
        .toast {
            background: white; border-left: 4px solid #3f2305; padding: 16px;
            border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-width: 250px; animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 12px;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Loader */
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid #3f2305; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Image Upload Styles */
        .image-slot {
            transition: all 0.2s;
        }
        .image-slot:hover {
            border-color: #d97706;
            background-color: #fff7ed;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-gray-800">

    <div id="auth-overlay" class="fixed inset-0 z-50 bg-primary flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-sm w-full border border-secondary">
            <h1 class="text-3xl font-bold brand-font text-primary mb-2">Admin Panel</h1>
            <p class="text-gray-500 mb-6">S Karuppatti Store Management</p>

            <form onsubmit="handleEmailLogin(event)" class="space-y-4 text-left">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email</label>
                    <input type="email" id="login-email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-secondary outline-none transition" placeholder="admin@skaruppatti.com">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Password</label>
                    <input type="password" id="login-password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-secondary outline-none transition" placeholder="••••••••">
                </div>
                <button type="submit" id="email-login-btn" class="w-full bg-primary text-white py-2.5 rounded-lg font-bold hover:bg-emerald-900 transition shadow-md border border-primary hover:border-white">
                    Login as Admin
                </button>
            </form>
            <p class="text-xs text-gray-400 mt-6">Restricted Access.</p>
        </div>
    </div>

    <div id="toast-container"></div>

    <aside class="w-64 bg-white shadow-xl flex flex-col z-20 hidden md:flex border-r border-gray-200">
        <div class="h-16 flex items-center justify-center border-b border-gray-200 bg-primary text-white">
            <h2 class="text-xl font-bold brand-font text-secondary">S Karuppatti Admin</h2>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-4">
            <ul class="space-y-1">
                <li><button onclick="switchTab('dashboard')" id="nav-dashboard" class="w-full flex items-center gap-3 px-6 py-3 text-primary bg-accent border-r-4 border-primary transition font-medium"><i class="fa-solid fa-chart-line w-6"></i> Dashboard</button></li>
                <li><button onclick="switchTab('products')" id="nav-products" class="w-full flex items-center gap-3 px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-primary transition font-medium"><i class="fa-solid fa-box w-6"></i> Products</button></li>
                <li><button onclick="switchTab('orders')" id="nav-orders" class="w-full flex items-center gap-3 px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-primary transition font-medium"><i class="fa-solid fa-cart-shopping w-6"></i> Orders</button></li>
            </ul>
        </nav>

        <div class="p-4 border-t border-gray-200">
            <div class="flex items-center gap-3 mb-4">
                <img id="admin-avatar" src="" onerror="this.src='https://ui-avatars.com/api/?name=Admin&background=3f2305&color=fff'" class="w-10 h-10 rounded-full bg-gray-200 object-cover border border-secondary">
                <div class="overflow-hidden">
                    <p id="admin-name" class="text-sm font-bold text-gray-800 truncate">Admin</p>
                    <p class="text-xs text-gray-500">Administrator</p>
                </div>
            </div>
            <button onclick="logout()" class="w-full text-red-500 bg-red-50 py-2 rounded-lg text-sm font-bold hover:bg-red-100 transition border border-red-100"><i class="fa-solid fa-right-from-bracket mr-2"></i> Logout</button>
        </div>
    </aside>

    <div class="md:hidden fixed top-0 left-0 right-0 h-16 bg-primary z-30 flex items-center justify-between px-4 text-white shadow-md">
        <span class="font-bold brand-font text-secondary">S Karuppatti Admin</span>
        <button onclick="toggleMobileMenu()" class="text-xl"><i class="fa-solid fa-bars"></i></button>
    </div>

    <main class="flex-1 flex flex-col h-screen overflow-hidden pt-16 md:pt-0">
        
        <div id="view-dashboard" class="flex-1 overflow-y-auto p-6 md:p-10">
            <h2 class="text-2xl font-bold text-primary mb-6 brand-font">Dashboard Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <p class="text-xs font-bold text-gray-500 uppercase">Total Revenue</p>
                    <h3 class="text-2xl font-bold text-primary mt-1" id="stat-revenue">₹0</h3>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <p class="text-xs font-bold text-gray-500 uppercase">Total Orders</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-1" id="stat-orders">0</h3>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <p class="text-xs font-bold text-gray-500 uppercase">Products</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-1" id="stat-products">0</h3>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <p class="text-xs font-bold text-gray-500 uppercase">Pending</p>
                    <h3 class="text-2xl font-bold text-orange-600 mt-1" id="stat-pending">0</h3>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="font-bold text-gray-800">Recent Orders</h3>
                    <button onclick="switchTab('orders')" class="text-sm text-secondary font-bold hover:underline">View All</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                            <tr>
                                <th class="px-6 py-3 font-semibold">Order ID</th>
                                <th class="px-6 py-3 font-semibold">Customer</th>
                                <th class="px-6 py-3 font-semibold">Amount</th>
                                <th class="px-6 py-3 font-semibold">Status</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-orders-table" class="text-sm divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-products" class="hidden flex-1 flex flex-col h-full overflow-hidden">
            <div class="p-6 md:px-10 md:pt-10 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-primary brand-font">Product Management</h2>
                <button onclick="openProductModal()" class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-emerald-900 transition">
                    <i class="fa-solid fa-plus mr-2"></i> Add Product
                </button>
            </div>
            <div class="flex-1 overflow-auto px-6 md:px-10 pb-10">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="products-grid"></div>
            </div>
        </div>

        <div id="view-orders" class="hidden flex-1 flex flex-col h-full overflow-hidden">
            <div class="p-6 md:px-10 md:pt-10">
                <h2 class="text-2xl font-bold text-primary brand-font">Customer Orders</h2>
            </div>
            <div class="flex-1 overflow-auto px-6 md:px-10 pb-10">
                <div class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-gray-50 text-gray-500 text-xs uppercase sticky top-0">
                                <tr>
                                    <th class="px-6 py-3">Date</th>
                                    <th class="px-6 py-3">Customer</th>
                                    <th class="px-6 py-3">Items</th>
                                    <th class="px-6 py-3">Total</th>
                                    <th class="px-6 py-3">Address</th>
                                    <th class="px-6 py-3">Status</th>
                                    <th class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orders-full-table" class="text-sm divide-y divide-gray-200 bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="product-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-60 backdrop-blur-sm" onclick="closeProductModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-6 relative max-h-[90vh] overflow-y-auto border-t-4 border-primary">
                <button onclick="closeProductModal()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
                
                <h2 class="text-xl font-bold text-primary mb-6 brand-font" id="modal-title">Add New Product</h2>
                
                <form onsubmit="handleProductSubmit(event)" class="space-y-4">
                    <input type="hidden" id="prod-id">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Product English Name</label>
                            <input type="text" id="prod-name-english" required class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-1 focus:ring-secondary outline-none" placeholder="e.g. Palm Jaggery">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Product Tamil Name</label>
                            <input type="text" id="prod-name-tamil" class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-1 focus:ring-secondary outline-none tamil-font" placeholder="e.g. கருப்பட்டி">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Old Price (MRP)</label>
                            <input type="number" id="prod-price-old" min="0" class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-1 focus:ring-secondary outline-none text-gray-500" placeholder="Optional">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-secondary uppercase mb-1">New Price (Selling)</label>
                            <input type="number" id="prod-price-new" required min="1" class="w-full px-3 py-2 border border-secondary rounded-lg text-sm focus:ring-1 focus:ring-secondary outline-none font-bold">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Unit</label>
                            <input type="text" id="prod-unit" required class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-1 focus:ring-secondary outline-none" placeholder="e.g. 500g">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Stock Quantity</label>
                            <input type="number" id="prod-stock" required min="0" class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-1 focus:ring-secondary outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Category</label>
                            <select id="prod-category" class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-1 focus:ring-secondary outline-none bg-white">
                                <option>Karuppatti / Jaggery</option>
                                <option>Dry Fruits</option>
                                <option>Millets</option>
                                <option>Spices</option>
                                <option>Oil / Ghee</option>
                                <option>Traditional Sweets</option>
                                <option>Combo</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Product Images (Max 5)</label>
                        <p class="text-[10px] text-gray-400 mb-2">Upload a file OR paste a direct URL. Image 1 is the main image.</p>
                        
                        <div class="space-y-2" id="image-inputs-container">
                            </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Description</label>
                        <textarea id="prod-desc" rows="3" class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-1 focus:ring-secondary outline-none"></textarea>
                    </div>

                    <div id="upload-loader" class="hidden flex items-center justify-center text-secondary text-sm font-bold animate-pulse my-2">
                        <i class="fa-solid fa-cloud-arrow-up mr-2"></i> Uploading Images...
                    </div>

                    <button type="submit" id="save-product-btn" class="w-full bg-primary text-white py-3 rounded-lg font-bold hover:bg-emerald-900 transition mt-2">
                        Save Product
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref, onValue, set, push, update, remove, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5jaPVkCwxXiMYhSn0uuW9QSMc-B5C9YY",
            authDomain: "mjsmartapps.firebaseapp.com",
            databaseURL: "https://mjsmartapps-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mjsmartapps",
            storageBucket: "mjsmartapps.firebasestorage.app",
            messagingSenderId: "1033240518010",
            appId: "1:1033240518010:web:930921011dda1bd56e0ac3",
            measurementId: "G-959VLQSHH2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const storage = getStorage(app);

        // --- AUTH & INIT LOGIC (Same as before) ---
        window.showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            const icon = type === 'success' ? '<i class="fa-solid fa-circle-check text-green-600"></i>' : '<i class="fa-solid fa-circle-exclamation text-red-600"></i>';
            toast.innerHTML = `${icon} <span class="font-medium text-sm text-gray-700">${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

        window.handleEmailLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('email-login-btn');
            const originalText = btn.innerText;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Checking...';
            btn.disabled = true;

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error(error);
                window.showToast("Login Failed: " + error.message, "error");
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            const authOverlay = document.getElementById('auth-overlay');
            if (user) {
                try {
                    // UPDATED PATH: skaruppatti-users
                    const userRef = ref(db, `skaruppatti-users/${user.uid}`);
                    const snapshot = await get(userRef);
                    if (snapshot.exists() && snapshot.val().role === 'admin') {
                        authOverlay.classList.add('hidden');
                        document.getElementById('admin-name').innerText = user.displayName || user.email.split('@')[0];
                        initDashboard();
                    } else {
                        await signOut(auth);
                        window.showToast("Access Denied: Not an admin.", "error");
                        authOverlay.classList.remove('hidden');
                    }
                } catch (error) {
                    await signOut(auth);
                    authOverlay.classList.remove('hidden');
                }
            } else {
                authOverlay.classList.remove('hidden');
                const btn = document.getElementById('email-login-btn');
                if(btn) { btn.innerText = 'Login as Admin'; btn.disabled = false; }
            }
        });

        window.switchTab = (tabId) => {
            ['dashboard', 'products', 'orders'].forEach(t => {
                const btn = document.getElementById(`nav-${t}`);
                if(t === tabId) btn.className = "w-full flex items-center gap-3 px-6 py-3 text-primary bg-accent border-r-4 border-primary transition font-medium";
                else btn.className = "w-full flex items-center gap-3 px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-primary transition font-medium";
                const view = document.getElementById(`view-${t}`);
                if(t === tabId) view.classList.remove('hidden'); else view.classList.add('hidden');
            });
        };

        window.toggleMobileMenu = () => { /* ... (mobile menu logic omitted for brevity, implied same) */ };

        // --- DATA HANDLING ---
        let allOrders = [];
        let allProducts = {};

        function initDashboard() {
            // UPDATED PATH: skaruppatti-products
            onValue(ref(db, 'skaruppatti-products'), (snapshot) => {
                allProducts = snapshot.val() || {};
                renderProducts();
                updateStats();
            });
            // UPDATED PATH: skaruppatti-orders
            onValue(ref(db, 'skaruppatti-orders'), (snapshot) => {
                const data = snapshot.val();
                if(data) {
                    allOrders = Object.entries(data).map(([key, val]) => ({...val, id: key})).sort((a,b) => b.orderDate - a.orderDate);
                    renderOrders();
                    updateStats();
                }
            });
            generateImageInputs();
        }

        function updateStats() {
            let revenue = 0; let pending = 0;
            allOrders.forEach(o => {
                const amt = parseFloat(o.totalAmount.toString().replace(/[^0-9.]/g, '')) || 0;
                if(o.status !== 'Cancelled') revenue += amt;
                if(o.status === 'Pending' || !o.status) pending++;
            });
            document.getElementById('stat-revenue').innerText = "₹" + revenue.toLocaleString();
            document.getElementById('stat-orders').innerText = allOrders.length;
            document.getElementById('stat-products').innerText = Object.keys(allProducts).length;
            document.getElementById('stat-pending').innerText = pending;
        }

        // --- PRODUCT LOGIC ---

        function renderProducts() {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = '';
            
            Object.entries(allProducts).forEach(([id, prod]) => {
                const stockColor = prod.stock > 10 ? 'bg-green-100 text-green-700' : (prod.stock > 0 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700');
                
                // Display Logic for new fields
                const nameEng = prod.nameEnglish || prod.name || 'Unknown';
                const nameTam = prod.nameTamil || '';
                const priceNew = prod.priceNew || prod.price || 0;
                const priceOld = prod.priceOld ? `<span class="line-through text-gray-400 text-xs mr-1">₹${prod.priceOld}</span>` : '';
                
                // Image Handling (Array or Single String)
                let mainImage = 'https://placehold.co/400x300?text=No+Image';
                if(Array.isArray(prod.images) && prod.images.length > 0) mainImage = prod.images[0];
                else if(prod.image) mainImage = prod.image;

                grid.innerHTML += `
                    <div class="bg-white rounded-xl shadow border border-gray-100 overflow-hidden flex flex-col group hover:shadow-lg transition">
                        <div class="h-48 relative overflow-hidden bg-gray-100">
                            <img src="${mainImage}" onerror="this.src='https://placehold.co/400x300?text=No+Image'" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                            <div class="absolute top-2 right-2 px-2 py-1 rounded text-xs font-bold ${stockColor}">Stock: ${prod.stock}</div>
                        </div>
                        <div class="p-4 flex flex-col flex-1">
                            <h3 class="font-bold text-gray-800 line-clamp-1">${nameEng}</h3>
                            <p class="text-xs text-primary tamil-font mb-1 line-clamp-1">${nameTam}</p>
                            <p class="text-xs text-gray-500 mb-2">${prod.category} • ${prod.unit}</p>
                            
                            <div class="mt-auto flex justify-between items-end">
                                <div>
                                    ${priceOld}
                                    <span class="font-bold text-secondary text-lg">₹${priceNew}</span>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editProduct('${id}')" class="w-8 h-8 rounded bg-gray-100 hover:bg-secondary hover:text-white transition flex items-center justify-center text-gray-600"><i class="fa-solid fa-pen"></i></button>
                                    <button onclick="deleteProduct('${id}')" class="w-8 h-8 rounded bg-red-50 hover:bg-red-500 hover:text-white transition flex items-center justify-center text-red-500"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // Generate 5 Image Input Slots
        function generateImageInputs() {
            const container = document.getElementById('image-inputs-container');
            let html = '';
            for(let i=0; i<5; i++) {
                html += `
                    <div class="flex items-center gap-2 image-slot p-1 border rounded bg-white">
                        <span class="text-gray-400 text-xs font-bold w-4 text-center">${i+1}</span>
                        <input type="file" id="img-file-${i}" accept="image/*" class="text-xs w-1/3 text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-secondary file:text-white hover:file:bg-amber-600">
                        <span class="text-xs text-gray-400">OR</span>
                        <input type="text" id="img-url-${i}" class="flex-1 text-xs border-b border-gray-300 focus:border-secondary outline-none px-1 py-1" placeholder="Paste Image URL">
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        window.openProductModal = (isEdit = false) => {
            const modal = document.getElementById('product-modal');
            modal.classList.remove('hidden');
            if(!isEdit) {
                document.getElementById('modal-title').innerText = "Add New Product";
                document.getElementById('prod-id').value = "";
                document.querySelector('form').reset();
                // Clear image inputs
                for(let i=0; i<5; i++) {
                    document.getElementById(`img-file-${i}`).value = "";
                    document.getElementById(`img-url-${i}`).value = "";
                }
            }
        };

        window.closeProductModal = () => document.getElementById('product-modal').classList.add('hidden');

        window.editProduct = (id) => {
            const prod = allProducts[id];
            if(!prod) return;
            
            document.getElementById('modal-title').innerText = "Edit Product";
            document.getElementById('prod-id').value = id;
            
            document.getElementById('prod-name-english').value = prod.nameEnglish || prod.name || '';
            document.getElementById('prod-name-tamil').value = prod.nameTamil || '';
            document.getElementById('prod-price-new').value = prod.priceNew || prod.price || '';
            document.getElementById('prod-price-old').value = prod.priceOld || '';
            document.getElementById('prod-unit').value = prod.unit || prod.weight || '';
            document.getElementById('prod-stock').value = prod.stock;
            document.getElementById('prod-category').value = prod.category || 'Karuppatti / Jaggery';
            document.getElementById('prod-desc').value = prod.description || '';

            // Populate Images
            for(let i=0; i<5; i++) {
                document.getElementById(`img-file-${i}`).value = ""; // Clear files
                let url = "";
                if(Array.isArray(prod.images) && prod.images[i]) url = prod.images[i];
                else if(i===0 && typeof prod.image === 'string') url = prod.image; // fallback for old data
                document.getElementById(`img-url-${i}`).value = url;
            }
            
            window.openProductModal(true);
        };

        window.handleProductSubmit = async (e) => {
            e.preventDefault();
            
            const loader = document.getElementById('upload-loader');
            const btn = document.getElementById('save-product-btn');
            loader.classList.remove('hidden');
            btn.classList.add('hidden');

            try {
                const id = document.getElementById('prod-id').value;
                const finalImages = [];

                // Handle Image Uploads
                for (let i = 0; i < 5; i++) {
                    const fileInput = document.getElementById(`img-file-${i}`);
                    const urlInput = document.getElementById(`img-url-${i}`);
                    
                    if (fileInput.files.length > 0) {
                        // File Selected -> Upload to Firebase Storage
                        const file = fileInput.files[0];
                        const sRef = storageRef(storage, `skaruppatti-products/${Date.now()}_${file.name}`);
                        await uploadBytes(sRef, file);
                        const downloadURL = await getDownloadURL(sRef);
                        finalImages.push(downloadURL);
                    } else if (urlInput.value.trim() !== "") {
                        // URL Provided -> Use it
                        finalImages.push(urlInput.value.trim());
                    }
                }

                const data = {
                    nameEnglish: document.getElementById('prod-name-english').value,
                    nameTamil: document.getElementById('prod-name-tamil').value,
                    priceNew: Number(document.getElementById('prod-price-new').value),
                    priceOld: Number(document.getElementById('prod-price-old').value),
                    unit: document.getElementById('prod-unit').value,
                    stock: Number(document.getElementById('prod-stock').value),
                    category: document.getElementById('prod-category').value,
                    description: document.getElementById('prod-desc').value,
                    images: finalImages,
                    // Keep old fields for backward compatibility if needed by frontend
                    name: document.getElementById('prod-name-english').value, 
                    price: Number(document.getElementById('prod-price-new').value),
                    image: finalImages.length > 0 ? finalImages[0] : ''
                };

                if(id) {
                    // UPDATED PATH: skaruppatti-products
                    await update(ref(db, `skaruppatti-products/${id}`), data);
                    window.showToast("Product Updated Successfully!");
                } else {
                    // UPDATED PATH: skaruppatti-products
                    await push(ref(db, 'skaruppatti-products'), data);
                    window.showToast("Product Added Successfully!");
                }
                window.closeProductModal();

            } catch (err) {
                console.error(err);
                window.showToast("Error saving product: " + err.message, "error");
            } finally {
                loader.classList.add('hidden');
                btn.classList.remove('hidden');
            }
        };

        window.deleteProduct = async (id) => {
            if(confirm("Are you sure you want to delete this product?")) {
                // UPDATED PATH: skaruppatti-products
                await remove(ref(db, `skaruppatti-products/${id}`));
                window.showToast("Product Deleted");
            }
        };

        // --- ORDER LOGIC (Existing) ---
        function renderOrders() {
            const dashboardTable = document.getElementById('dashboard-orders-table');
            const fullTable = document.getElementById('orders-full-table');
            dashboardTable.innerHTML = ''; fullTable.innerHTML = '';

            allOrders.slice(0, 5).forEach(order => {
                dashboardTable.innerHTML += `<tr><td class="px-6 py-3 font-medium">#${order.id.slice(-6)}</td><td class="px-6 py-3">${order.customerName}</td><td class="px-6 py-3 font-bold text-primary">${order.totalAmount}</td><td class="px-6 py-3"><span class="text-xs px-2 py-1 rounded ${getStatusColor(order.status)}">${order.status || 'Pending'}</span></td></tr>`;
            });

            allOrders.forEach(order => {
                const date = new Date(order.orderDate).toLocaleDateString();
                const itemsList = order.items.map(i => `<div class="text-xs text-gray-600">${i.name} (${i.qty})</div>`).join('');
                fullTable.innerHTML += `<tr class="table-row-hover border-b border-gray-100"><td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500">${date}</td><td class="px-6 py-4"><div class="text-sm font-bold text-primary">${order.customerName}</div><div class="text-xs text-gray-500">${order.customerPhone}</div></td><td class="px-6 py-4">${itemsList}</td><td class="px-6 py-4 font-bold text-primary">${order.totalAmount}</td><td class="px-6 py-4 max-w-xs"><p class="text-xs text-gray-600 truncate" title="${order.address}">${order.address}</p></td><td class="px-6 py-4"><select onchange="updateStatus('${order.id}', this.value)" class="bg-gray-50 border border-gray-200 text-xs rounded px-2 py-1 focus:outline-none focus:border-secondary ${getStatusColor(order.status)}"><option value="Pending" ${order.status==='Pending'?'selected':''}>Pending</option><option value="Processing" ${order.status==='Processing'?'selected':''}>Processing</option><option value="Shipped" ${order.status==='Shipped'?'selected':''}>Shipped</option><option value="Delivered" ${order.status==='Delivered'?'selected':''}>Delivered</option><option value="Cancelled" ${order.status==='Cancelled'?'selected':''}>Cancelled</option></select></td><td class="px-6 py-4 text-right"><a href="tel:${order.customerPhone}" class="text-gray-400 hover:text-primary"><i class="fa-solid fa-phone"></i></a></td></tr>`;
            });
        }

        function getStatusColor(status) {
            switch(status) {
                case 'Pending': return 'text-orange-600 bg-orange-50';
                case 'Processing': return 'text-blue-600 bg-blue-50';
                case 'Shipped': return 'text-purple-600 bg-purple-50';
                case 'Delivered': return 'text-green-600 bg-green-50';
                case 'Cancelled': return 'text-red-600 bg-red-50';
                default: return 'text-gray-600 bg-gray-50';
            }
        }

        window.updateStatus = async (orderId, newStatus) => {
            // UPDATED PATH: skaruppatti-orders
            try { await update(ref(db, `skaruppatti-orders/${orderId}`), { status: newStatus }); window.showToast(`Order marked as ${newStatus}`); }
            catch (e) { window.showToast("Failed", "error"); }
        };

        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
    </script>
</body>
</html>